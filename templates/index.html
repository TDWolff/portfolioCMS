{% extends "layouts/base.html" %}
{% set project = "Home" %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Application Management</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col" class="sortable" onclick="sortTable('name')" style="cursor: pointer;">
                                Name <span id="name-sort-icon"></span>
                            </th>
                            <th scope="col" class="sortable" onclick="sortTable('status')" style="cursor: pointer;">
                                Status <span id="status-sort-icon"></span>
                            </th>
                            <th scope="col">Link</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="websitesTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Add New Item Button -->
            <div class="mt-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <i class="fa fa-plus"></i> Add New Item
                </button>
                <button class="btn btn-success ms-2" onclick="refreshAllStatus()">
                    <i class="fa fa-refresh"></i> Refresh All Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="itemName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemLink" class="form-label">Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="itemProtocol" value="https://" style="max-width: 80px;">
                            <input type="text" class="form-control" id="itemDomain" placeholder="example.com" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewItem()">Add Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    <input type="hidden" id="editItemOldName">
                    <input type="hidden" id="editItemOldUrl">
                    <div class="mb-3">
                        <label for="editItemName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editItemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editItemLink" class="form-label">Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="editItemProtocol" value="https://" style="max-width: 80px;">
                            <input type="text" class="form-control" id="editItemDomain" placeholder="example.com" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedItem()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    let loggedIn = document.cookie.split('; ').find(row => row.startsWith('loggedIn='));
    if (loggedIn && loggedIn.split('=')[1] === 'false') {
        window.location.href = "/login";
    }
    
    function logout() {
        loggedIn = false;
        document.cookie = "loggedIn=false;";
        window.location.href = "/login";
    }

    // Sorting state
    let currentWebsites = [];
    let sortState = {
        name: 'off',     // 'off', 'asc', 'desc'
        status: 'off'    // 'off', 'asc', 'desc'
    };
    let currentSortColumn = null;

    // Load websites on page load and auto-check statuses
    async function loadWebsites() {
        try {
            const response = await fetch('/api/websites');
            const data = await response.json();
            
            if (data.success) {
                currentWebsites = data.websites;
                displayWebsites(currentWebsites);
                
                // Auto-check all statuses after initial load
                await checkAllWebsiteStatuses();
            }
        } catch (error) {
            console.error('Error loading websites:', error);
        }
    }

    // Check all websites' status automatically
    async function checkAllWebsiteStatuses() {
        const header = document.querySelector('h2');
        const originalHeaderText = header.textContent;
        header.innerHTML = `${originalHeaderText} <span class="spinner-border spinner-border-sm" role="status"></span> <small class="text-muted">Checking status...</small>`;
        
        const promises = currentWebsites.map(async (website, index) => {
            try {
                await new Promise(resolve => setTimeout(resolve, index * 200));
                
                const response = await fetch('/pokeURL', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        url: website.url 
                    })
                });

                const data = await response.json();
                console.log(`Status check for ${website.name}: ${data.success ? 'success' : 'failed'}`);
                
                return data;
            } catch (error) {
                console.error(`Error checking ${website.name}:`, error);
                return { success: false, error: error.message };
            }
        });

        await Promise.all(promises);
        
        // Reload websites after status check
        try {
            const response = await fetch('/api/websites');
            const data = await response.json();
            
            if (data.success) {
                currentWebsites = data.websites;
                displayWebsites(currentWebsites);
                console.log('All website statuses updated');
            }
        } catch (error) {
            console.error('Error reloading websites after status check:', error);
        }
        
        header.innerHTML = originalHeaderText;
    }

    // Manual refresh function
    async function refreshAllStatus() {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Refreshing...';
        button.disabled = true;
        
        try {
            await checkAllWebsiteStatuses();
        } finally {
            button.innerHTML = '<i class="fa fa-refresh"></i> Refresh All Status';
            button.disabled = false;
        }
    }

    // Sort table function
    function sortTable(column) {
        // Reset other column's sort state when clicking a different column
        if (currentSortColumn && currentSortColumn !== column) {
            sortState[currentSortColumn] = 'off';
            updateSortIcon(currentSortColumn, 'off');
        }
        
        currentSortColumn = column;
        
        // Cycle through sort states: off -> asc -> desc -> off
        switch (sortState[column]) {
            case 'off':
                sortState[column] = 'asc';
                break;
            case 'asc':
                sortState[column] = 'desc';
                break;
            case 'desc':
                sortState[column] = 'off';
                break;
        }
        
        updateSortIcon(column, sortState[column]);
        
        let sortedWebsites = [...currentWebsites];
        
        if (sortState[column] === 'off') {
            // No sorting - use original order
            displayWebsites(currentWebsites);
            return;
        }
        
        if (column === 'name') {
            sortedWebsites.sort((a, b) => {
                const comparison = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                return sortState[column] === 'asc' ? comparison : -comparison;
            });
        } else if (column === 'status') {
            sortedWebsites.sort((a, b) => {
                // Active comes before inactive in ascending order
                const statusOrder = { 'active': 1, 'inactive': 2 };
                const comparison = statusOrder[a.status] - statusOrder[b.status];
                return sortState[column] === 'asc' ? comparison : -comparison;
            });
        }
        
        displayWebsites(sortedWebsites);
    }

    // Update sort icons
    function updateSortIcon(column, state) {
        const icon = document.getElementById(`${column}-sort-icon`);
        switch (state) {
            case 'off':
                icon.innerHTML = '';
                break;
            case 'asc':
                icon.innerHTML = '<i class="fa fa-sort-up"></i>';
                break;
            case 'desc':
                icon.innerHTML = '<i class="fa fa-sort-down"></i>';
                break;
        }
    }

    // Display websites in table
    function displayWebsites(websites) {
        const tbody = document.getElementById('websitesTableBody');
        tbody.innerHTML = '';
        
        websites.forEach(website => {
            const row = createWebsiteRow(website);
            tbody.appendChild(row);
        });
    }

    // Create a table row for a website
    function createWebsiteRow(website) {
        const row = document.createElement('tr');
        
        const statusClasses = {
            'active': 'bg-success',
            'inactive': 'bg-secondary'
        };
        
        const isActive = website.status === 'active';
        const linkButton = isActive ? 
            `<a href="${website.url}" target="_blank" class="btn btn-outline-primary btn-sm">View</a>` : 
            `<a href="#" data-url="${website.url}" class="btn btn-outline-secondary btn-sm disabled">View</a>`;
        
        // Dynamic start/stop button based on status
        const serverButton = isActive ? 
            `<button class="btn btn-danger btn-sm me-1" onclick="stopServer(this)" data-action="stop">
                <i class="fa fa-stop"></i> Stop
            </button>` : 
            `<button class="btn btn-success btn-sm me-1" onclick="startServer(this)" data-action="start">
                <i class="fa fa-play"></i> Start
            </button>`;
        
        row.innerHTML = `
            <td>${website.name}</td>
            <td><span class="badge ${statusClasses[website.status]}">${website.status.charAt(0).toUpperCase() + website.status.slice(1)}</span></td>
            <td>${linkButton}</td>
            <td>
                ${serverButton}
                <button class="btn btn-warning btn-sm me-1" onclick="editItem(this)">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteItem(this)">Delete</button>
            </td>
        `;
        
        return row;
    }

    // Add new item
    async function addNewItem() {
        const name = document.getElementById('itemName').value;
        const protocol = document.getElementById('itemProtocol').value;
        const domain = document.getElementById('itemDomain').value;
        const link = protocol + domain;

        if (!name) {
            alert('Please enter a name');
            return;
        }

        if (!domain) {
            alert('Please enter a domain');
            return;
        }

        const addButton = document.querySelector('#addItemModal .btn-primary');
        const originalText = addButton.textContent;
        addButton.textContent = 'Adding...';
        addButton.disabled = true;

        try {
            const response = await fetch('/api/websites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, url: link })
            });

            const data = await response.json();

            if (data.success) {
                // Reload the websites
                await loadWebsites();
                
                // Clear form and close modal
                document.getElementById('addItemForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                modal.hide();
            } else {
                alert('Error adding website: ' + data.error);
            }
        } catch (error) {
            alert('Error adding website: ' + error.message);
        } finally {
            addButton.textContent = originalText;
            addButton.disabled = false;
        }
    }

    // Test website
    async function testWebsite(button) {
        const row = button.closest('tr');
        const name = row.cells[0].textContent;
        const linkCell = row.cells[2];
        const linkElement = linkCell.querySelector('a');
        const url = linkElement.getAttribute('data-url') || linkElement.href;
        
        if (!url || url === '#' || (url.includes('#') && !url.startsWith('http'))) {
            alert('No valid URL found for this item');
            return;
        }

        button.textContent = 'Testing...';
        button.disabled = true;

        try {
            const response = await fetch('/api/websites/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, url: url })
            });

            const data = await response.json();

            if (data.success) {
                // Reload the websites and maintain current sort
                const response = await fetch('/api/websites');
                const newData = await response.json();
                
                if (newData.success) {
                    currentWebsites = newData.websites;
                    
                    // Reapply current sort if any
                    if (currentSortColumn && sortState[currentSortColumn] !== 'off') {
                        sortTable(currentSortColumn);
                        // Need to call sortTable twice to get to the right state
                        sortState[currentSortColumn] = sortState[currentSortColumn] === 'asc' ? 'off' : 'asc';
                        sortTable(currentSortColumn);
                    } else {
                        displayWebsites(currentWebsites);
                    }
                }
            } else {
                alert('Error testing website: ' + data.error);
            }
        } catch (error) {
            alert('Error testing website: ' + error.message);
        } finally {
            button.textContent = 'Test';
            button.disabled = false;
        }
    }

    // Edit item
    function editItem(button) {
        const row = button.closest('tr');
        const name = row.cells[0].textContent;
        const linkCell = row.cells[2];
        const linkElement = linkCell.querySelector('a');
        const url = linkElement.getAttribute('data-url') || linkElement.href;
        
        // Split URL into protocol and domain
        const urlMatch = url.match(/^(https?:\/\/)(.+)$/);
        const protocol = urlMatch ? urlMatch[1] : 'https://';
        const domain = urlMatch ? urlMatch[2] : url;
        
        // Populate edit form
        document.getElementById('editItemOldName').value = name;
        document.getElementById('editItemOldUrl').value = url;
        document.getElementById('editItemName').value = name;
        document.getElementById('editItemProtocol').value = protocol;
        document.getElementById('editItemDomain').value = domain;
        
        // Show edit modal
        const editModal = new bootstrap.Modal(document.getElementById('editItemModal'));
        editModal.show();
    }

    // Save edited item
    async function saveEditedItem() {
        const oldName = document.getElementById('editItemOldName').value;
        const oldUrl = document.getElementById('editItemOldUrl').value;
        const newName = document.getElementById('editItemName').value;
        const newProtocol = document.getElementById('editItemProtocol').value;
        const newDomain = document.getElementById('editItemDomain').value;
        const newUrl = newProtocol + newDomain;

        if (!newName || !newDomain) {
            alert('Please fill in all fields');
            return;
        }

        const saveButton = document.querySelector('#editItemModal .btn-primary');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;

        try {
            const response = await fetch('/api/websites', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_name: oldName,
                    old_url: oldUrl,
                    new_name: newName,
                    new_url: newUrl
                })
            });

            const data = await response.json();

            if (data.success) {
                // Reload the websites
                await loadWebsites();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
                modal.hide();
            } else {
                alert('Error editing website: ' + data.error);
            }
        } catch (error) {
            alert('Error editing website: ' + error.message);
        } finally {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        }
    }

    // Delete item
    async function deleteItem(button) {
        const row = button.closest('tr');
        const name = row.cells[0].textContent;
        const linkCell = row.cells[2];
        const linkElement = linkCell.querySelector('a');
        const url = linkElement.getAttribute('data-url') || linkElement.href;
        
        if (!confirm(`Are you sure you want to delete "${name}"?`)) {
            return;
        }

        try {
            const response = await fetch('/api/websites', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, url: url })
            });

            const data = await response.json();

            if (data.success) {
                // Reload the websites
                await loadWebsites();
            } else {
                alert('Error deleting website: ' + data.error);
            }
        } catch (error) {
            alert('Error deleting website: ' + error.message);
        }
    }

    // Start server
    async function startServer(button) {
        const row = button.closest('tr');
        const serverName = row.cells[0].textContent;
        
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Starting...';
        button.disabled = true;
        
        try {
            const response = await fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: serverName })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update the button to show stop instead
                button.outerHTML = `<button class="btn btn-danger btn-sm me-1" onclick="stopServer(this)" data-action="stop">
                    <i class="fa fa-stop"></i> Stop
                </button>`;
                
                // Update status badge to active
                const statusBadge = row.cells[1].querySelector('.badge');
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Active';
                
                // Enable view button if it was disabled
                const viewButton = row.cells[2].querySelector('a');
                if (viewButton.classList.contains('disabled')) {
                    viewButton.classList.remove('btn-outline-secondary', 'disabled');
                    viewButton.classList.add('btn-outline-primary');
                    viewButton.setAttribute('target', '_blank');
                }
                
                alert('Server started successfully: ' + data.message);
            } else {
                alert('Failed to start server: ' + data.error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        } catch (error) {
            alert('Error starting server: ' + error.message);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    // Stop server
    async function stopServer(button) {
        const row = button.closest('tr');
        const serverName = row.cells[0].textContent;
        
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Stopping...';
        button.disabled = true;
        
        try {
            const response = await fetch('/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: serverName })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update the button to show start instead
                button.outerHTML = `<button class="btn btn-success btn-sm me-1" onclick="startServer(this)" data-action="start">
                    <i class="fa fa-play"></i> Start
                </button>`;
                
                // Update status badge to inactive
                const statusBadge = row.cells[1].querySelector('.badge');
                statusBadge.className = 'badge bg-secondary';
                statusBadge.textContent = 'Inactive';
                
                // Disable view button
                const viewButton = row.cells[2].querySelector('a');
                viewButton.classList.remove('btn-outline-primary');
                viewButton.classList.add('btn-outline-secondary', 'disabled');
                viewButton.removeAttribute('target');
                viewButton.href = '#';
                
                alert('Server stopped successfully: ' + data.message);
            } else {
                alert('Failed to stop server: ' + data.error);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        } catch (error) {
            alert('Error stopping server: ' + error.message);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    // Load websites when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadWebsites();
    });
</script>

<style>
    .sortable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sortable {
        user-select: none;
    }
    
    #name-sort-icon, #status-sort-icon {
        margin-left: 5px;
        opacity: 0.7;
    }
</style>

<footer>
    <div class="container text-center mt-4">
        <button class="button" onclick="logout()">Logout</button>
    </div>
</footer>

{% endblock %}